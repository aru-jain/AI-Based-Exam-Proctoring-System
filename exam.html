<html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Proctoring System</title>
    <style>
         * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #2d3748;
        }
        
        .exam-container {
            background-color: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
        }
        
        @media (min-width: 768px) {
            .exam-container {
                padding: 3rem;
            }
        }
        
        .header-logo {
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .header-logo img {
            height: 80px;
            width: auto;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
            transition: transform 0.3s ease;
        }
        
        .header-logo img:hover {
            transform: scale(1.05);
        }
        
        h2 {
            color: #4a5568;
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        h2::after {
            content: "";
            display: block;
            width: 80px;
            height: 4px;
            background: linear-gradient(to right, #667eea, #764ba2);
            margin: 0.5rem auto;
            border-radius: 2px;
        }
        
        p {
            color: #4a5568;
            font-size: 1.125rem;
            line-height: 1.6;
            margin-bottom: 2rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }
        
        button {
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 50px;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            margin-bottom: 2rem;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(1px);
    } 



        
        .exam-content {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 15px;
            border: 1px solid #e2e8f0;
            margin-top: 2rem;
            display: none;
            animation: fadeIn 0.6s ease forwards;
            position: relative;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .proctoring-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 240px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            padding: 10px;
            border: 1px solid #e2e8f0;
            display: none; /* Hidden initially */
        }
        
        .proctoring-overlay h3 {
            font-size: 1rem;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .proctoring-overlay img {
            width: 100%;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        #aiResult {
            font-size: 0.875rem;
            padding: 6px;
            margin-top: 8px;
            text-align: center;
        }
        
        .quiz-column {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }
        
        h3 {
            color: #4a5568;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .quiz-questions {
            text-align: left;
            margin-bottom: 2rem;
        }
        
        .question {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .question:last-child {
            border-bottom: none;
        }
        
        .question p {
            font-weight: 600;
            margin-bottom: 1rem;
            max-width: 100%;
            text-align: left;
        }
        
        .options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .option input {
            accent-color: #667eea;
        }
        
        .quiz-result {
            font-weight: bold;
            font-size: 1.125rem;
            margin-top: 1rem;
            text-align: center;
        }
        
        .loader {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin: 20px auto;
            display: block;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        
        .modal {
            background-color: white;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            animation: modalFadeIn 0.3s ease forwards;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal h3 {
            margin-bottom: 1.5rem;
            color: #4a5568;
            text-align: center;
        }
        
        .modal-content {
            margin-bottom: 1.5rem;
            font-size: 1rem;
            line-height: 1.6;
            color: #4a5568;
        }
        
        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        
        .modal-actions button {
            margin-bottom: 0;
        }

        #chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px;
            background: #f1f1f1;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            font-family: Arial, sans-serif;
            z-index: 9999;
        }
        
        #chat-header {
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white;
            padding: 10px;
            border-radius: 10px 10px 0 0;
            display: flex;
            align-items: center;
        }
        
        #chat-header img {
            height: 30px;
            width: 30px;
            margin-right: 10px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        #chat-header h4 {
            margin: 0;
            font-weight: 600;
        }
        
        #chat-window {
            height: 260px;
            overflow-y: auto;
            padding: 10px;
            background: #ffffff;
            border-bottom: 1px solid #ccc;
        }
        
        #chat-input-area {
            display: flex;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 0 0 10px 10px;
        }
        
        #user-input {
            flex: 1;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 20px;
            outline: none;
        }
        
        #send-button {
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            margin-left: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #send-button:hover {
            opacity: 0.9;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .message.user {
            background: #e3f2fd;
            margin-left: auto;
            border-bottom-right-radius: 4px;
            color: #333;
        }
        
        .message.bot {
            background: #f1f1f1;
            margin-right: auto;
            border-bottom-left-radius: 4px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="exam-container">
        <h2>Welcome Student üëã</h2>
        <p>Get ready to start your exam. Make sure your camera and microphone are on.</p>
        
        <!-- Proctoring Overlay -->
        <div id="proctorOverlay" class="proctoring-overlay">
            <h3>Proctoring üé•</h3>
            <img id="webcam" src="{{ url_for('video_feed') }}" height="160">
            <p id="aiResult"></p>
        </div>

        <!-- Mobile Detection Warning -->
        <div id="mobileWarning" style="display:none; background-color: #ffe6e6; color: #cc0000; border: 1px solid #cc0000; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 1rem;">
            ‚ö†Ô∏è Mobile phone detected! Please do not use mobile devices during the exam.
        </div>
        
        <button id="startExamBtn">Start Exam</button>
        
        <div id="examContent" class="exam-content">
            <!-- Main quiz content -->
            <div class="quiz-column">
                <h3>Exam Questions üìù</h3>
                <div id="quizQuestions" class="quiz-questions">
                    <div class="loader"></div>
                    <p>Loading quiz questions...</p>
                </div>
                
                <button id="submitQuizBtn" style="display: none;">Submit Quiz</button>
                <div id="quizResult" class="quiz-result" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <!-- Terms and Conditions Modal -->
    <div id="termsModal" class="modal-overlay">
        <div class="modal">
            <h3>Exam Terms and Conditions</h3>
            <div class="modal-content">
                <p>Please read and accept the following terms and conditions before proceeding with the exam:</p>
                <ol style="margin-left: 1.5rem; margin-top: 1rem; margin-bottom: 1rem;">
                    <li>This is a proctored exam. Your webcam and microphone must remain on throughout the exam.</li>
                    <li>No external resources, books, notes, or additional devices are permitted during the exam.</li>
                    <li>Switching tabs or minimizing the browser window is not allowed and will be flagged as cheating.</li>
                    <li>You must remain visible in the webcam view at all times.</li>
                    <li>No communication with others is allowed during the exam.</li>
                    <li>Failure to comply with these rules may result in disqualification.</li>
                    <li>Your exam session will be monitored and recorded for security purposes.</li>
                    <li>Time limits must be strictly observed. The exam will automatically submit when time expires.</li>
                </ol>
                <p>By clicking "I Agree", you acknowledge that you have read, understood, and agree to abide by these terms and conditions.</p>
            </div>
            <div class="modal-actions">
                <button id="declineTermsBtn" style="background: #e53e3e;">Decline</button>
                <button id="acceptTermsBtn">I Agree</button>
            </div>
        </div>
    </div>

    <!-- Exam Ended Modal -->
    <div id="examEndedModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <h3>Exam Ended</h3>
            <div class="modal-content">
                <p>‚ö†Ô∏è You cannot continue your exam as the maximum violation limit has been reached.</p>
            </div>
            <div class="modal-actions">
                <button id="endTestBtn" style="background: #e53e3e;">End Test</button>
            </div>
        </div>
    </div>
    
    <!-- Chatbot Container with Logo -->
    <div id="chat-container">
        <div id="chat-header">
            <img src="{{ url_for('static', filename='images/erica-logo.png.jpg') }}" alt="Erica">
            <h4>Erica Assistant</h4>
        </div>
        <div id="chat-window"></div>
        <div id="chat-input-area">
            <input type="text" id="user-input" placeholder="Ask Erica anything..." />
            <button id="send-button">Send</button>
        </div>
    </div>

    <script>
      {#// DOM elements
const startExamBtn = document.getElementById('startExamBtn');
const examContent = document.getElementById('examContent');
const proctorOverlay = document.getElementById('proctorOverlay');
const quizQuestionsContainer = document.getElementById('quizQuestions');
const submitQuizBtn = document.getElementById('submitQuizBtn');
const quizResult = document.getElementById('quizResult');
const termsModal = document.getElementById('termsModal');
const acceptTermsBtn = document.getElementById('acceptTermsBtn');
const declineTermsBtn = document.getElementById('declineTermsBtn');
const examEndedModal = document.getElementById('examEndedModal');
const endTestBtn = document.getElementById('endTestBtn');

// Violation tracking variables
let faceNotVisibleCount = 0;
let focusLostCount = 0;
let mobileDetectedCount = 0;
let totalViolations = 0;
const MAX_VIOLATIONS = 3;

// Store questions and answers
let quizQuestions = [];

// Functions
function showWarning(message) {
    // Create a warning element if it doesn't exist
    let warningElement = document.getElementById('violationWarning');
    if (!warningElement) {
        warningElement = document.createElement('div');
        warningElement.id = 'violationWarning';
        warningElement.style.backgroundColor = '#fff3cd';
        warningElement.style.color = '#856404';
        warningElement.style.border = '1px solid #ffeeba';
        warningElement.style.padding = '12px';
        warningElement.style.borderRadius = '8px';
        warningElement.style.margin = '10px 0';
        warningElement.style.textAlign = 'center';
        warningElement.style.fontWeight = 'bold';
        warningElement.style.animation = 'fadeIn 0.5s ease';
        
        // Add it to the top of the quiz area
        quizQuestionsContainer.parentNode.insertBefore(warningElement, quizQuestionsContainer);
    }
    
    // Set the warning message and make it visible
    warningElement.innerHTML = message;
    warningElement.style.display = 'block';
    
    // Make it flash to draw attention
    warningElement.style.animation = 'none';
    setTimeout(() => {
        warningElement.style.animation = 'fadeIn 0.5s ease';
    }, 10);
    
    // Auto hide after 5 seconds
    setTimeout(() => {
        warningElement.style.display = 'none';
    }, 5000);
}

function showTermsModal() {
    termsModal.style.display = "flex";
}

function hideTermsModal() {
    termsModal.style.display = "none";
}

function showExamEndedModal() {
    examEndedModal.style.display = "flex";
}

function hideExamEndedModal() {
    examEndedModal.style.display = "none";
}

function startExam() {
    examContent.style.display = "block";
    proctorOverlay.style.display = "block"; // Show proctoring overlay
    startExamBtn.style.display = "none";

    loadQuizQuestions();  // Show quiz when exam starts

    // Call cheating detection every 3 seconds
    setInterval(() => {
        fetch('/detect')
            .then(response => response.json())
            .then(data => {
                const resultElement = document.getElementById("aiResult");
                if (data.cheating_detected) {
                    resultElement.textContent = data.reason;
                    resultElement.style.color = "red";
                    
                    // Check if violation is related to face not visible
                    if (data.reason.toLowerCase().includes("face") || 
                        data.reason.toLowerCase().includes("not visible")) {
                        faceNotVisibleCount++;
                        totalViolations = faceNotVisibleCount + focusLostCount + mobileDetectedCount;
                        
                        // Show warning with count
                        showWarning(`‚ö†Ô∏è Face not detected! Please stay visible during the exam. Violation ${totalViolations}/${MAX_VIOLATIONS}`);
                        
                        checkViolationsAndSubmit();
                    }
                } else {
                    resultElement.textContent = "‚úÖ No cheating detected";
                    resultElement.style.color = "green";
                }
            })
            .catch(err => {
                console.error("Detection failed", err);
            });
    }, 3000);
}

function loadQuizQuestions() {
    fetch('/quiz_questions')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch quiz questions');
            }
            return response.json();
        })
        .then(questions => {
            quizQuestions = questions;
            displayQuizQuestions(questions);
        })
        .catch(error => {
            console.error('Error loading questions:', error);
            quizQuestionsContainer.innerHTML = `
                <p style="color: red;">Failed to load quiz questions. Please try again.</p>
                <button onclick="loadQuizQuestions()">Retry</button>
            `;
        });
}

function displayQuizQuestions(questions) {
    quizQuestionsContainer.innerHTML = '';
    
    if (!questions || questions.length === 0) {
        quizQuestionsContainer.innerHTML = '<p>No questions available.</p>';
        return;
    }
    
    questions.forEach(question => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question';
        
        // Display the question text with HTML entities decoded
        const questionText = document.createElement('p');
        questionText.innerHTML = decodeHtmlEntities(question.question);
        questionDiv.appendChild(questionText);
        
        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'options';
        
        question.options.forEach(option => {
            const optionLabel = document.createElement('label');
            optionLabel.className = 'option';
            
            const optionInput = document.createElement('input');
            optionInput.type = 'radio';
            optionInput.name = `q${question.id}`;
            optionInput.value = option;
            
            const optionText = document.createElement('span');
            optionText.innerHTML = decodeHtmlEntities(option);
            
            optionLabel.appendChild(optionInput);
            optionLabel.appendChild(optionText);
            optionsDiv.appendChild(optionLabel);
        });
        
        questionDiv.appendChild(optionsDiv);
        quizQuestionsContainer.appendChild(questionDiv);
    });
    
    submitQuizBtn.style.display = "block";
}

function decodeHtmlEntities(text) {
    const textArea = document.createElement('textarea');
    textArea.innerHTML = text;
    return textArea.value;
}

function submitQuiz() {
    const answers = {};
    const radios = document.querySelectorAll('input[type="radio"]:checked');
    
    radios.forEach(radio => {
        const qid = radio.name.replace('q', '');
        answers[qid] = radio.value;
    });

    fetch('/submit_quiz', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ answers: answers })
    })
    .then(response => response.json())
    .then(data => {
        quizResult.textContent = `‚úÖ You scored ${data.score}/${data.total}`;
        quizResult.style.display = "block";
        submitQuizBtn.style.display = "none";
        
        // Disable all radio buttons
        const radioInputs = document.querySelectorAll('input[type="radio"]');
        radioInputs.forEach(input => {
            input.disabled = true;
        });
    })
    .catch(error => {
        console.error('Error submitting quiz:', error);
        quizResult.textContent = "‚ö†Ô∏è Failed to submit quiz. Please try again.";
        quizResult.style.display = "block";
        quizResult.style.color = "red";
    });
}

function checkViolationsAndSubmit() {
    console.log("Checking violations: " + totalViolations + "/" + MAX_VIOLATIONS);
    if (totalViolations >= MAX_VIOLATIONS) {
        // Log the auto-submission event
        fetch('/log_cheating', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                reason: 'Auto-submitted after ' + MAX_VIOLATIONS + ' violations',
                faceViolations: faceNotVisibleCount,
                tabViolations: focusLostCount,
                mobileViolations: mobileDetectedCount
            })
        });
        
        // Auto-submit the quiz
        submitQuiz();

        // Show exam ended modal
        showExamEndedModal();

        // Hide exam content and proctor overlay to prevent further interaction
        examContent.style.display = "none";
        proctorOverlay.style.display = "none";
    }
}

function pollMobileDetection() {
    fetch('/mobile_detect')
        .then(response => response.json())
        .then(data => {
            const mobileWarning = document.getElementById('mobileWarning');
            if (data.mobile_detected) {
                mobileWarning.style.display = 'block';
                
                // Add mobile detection to violations count and show warning
                if (examContent.style.display === "block") {
                    // Only count as violation if exam has started
                    mobileDetectedCount++;
                    totalViolations = faceNotVisibleCount + focusLostCount + mobileDetectedCount;
                    
                    showWarning(`‚ö†Ô∏è Mobile phone detected! Please keep mobile devices away. Violation ${totalViolations}/${MAX_VIOLATIONS}`);
                    
                    // Log mobile detection as cheating
                    fetch('/log_cheating', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ reason: 'Mobile phone detected during exam' })
                    });
                    
                    // Check if max violations reached
                    checkViolationsAndSubmit();
                }
            } else {
                mobileWarning.style.display = 'none';
            }
        })
        .catch(err => {
            console.error('Mobile detection failed', err);
        });
}

// Event listeners
startExamBtn.addEventListener('click', function() {
    showTermsModal();
});

acceptTermsBtn.addEventListener('click', function() {
    hideTermsModal();
    startExam();
});

declineTermsBtn.addEventListener('click', function() {
    hideTermsModal();
    // Show warning message instead of alert
    showWarning("You must accept the terms and conditions to start the exam.");
});

submitQuizBtn.addEventListener('click', submitQuiz);#}



function displayQuizAnalysis(data, timeElapsedFormatted, attemptedQuestions) {
    // Clear previous results
    quizResult.style.display = "none";
    quizAnalysisContainer.style.display = "block";
    quizAnalysisContainer.innerHTML = "";
    
    // Calculate percentages
    const scorePercent = (data.score / data.total) * 100;
    const attemptedPercent = (attemptedQuestions / data.total) * 100;
    
    // Create results header
    const resultHeader = document.createElement('div');
    resultHeader.style.textAlign = 'center';
    resultHeader.style.marginBottom = '20px';
    
    const scoreDisplay = document.createElement('h2');
    scoreDisplay.textContent = `Your Score: ${data.score}/${data.total} (${scorePercent.toFixed(1)}%)`;
    scoreDisplay.style.color = scorePercent >= 60 ? '#28a745' : '#dc3545';
    resultHeader.appendChild(scoreDisplay);
    
    // Create result status
    const resultStatus = document.createElement('div');
    resultStatus.style.fontSize = '1.2rem';
    resultStatus.style.padding = '10px';
    resultStatus.style.borderRadius = '5px';
    resultStatus.style.marginBottom = '15px';
    
    if (scorePercent >= 80) {
        resultStatus.textContent = 'üéì Excellent! Great job on the exam!';
        resultStatus.style.backgroundColor = '#d4edda';
        resultStatus.style.color = '#155724';
    } else if (scorePercent >= 60) {
        resultStatus.textContent = 'üëç Good work! You passed the exam.';
        resultStatus.style.backgroundColor = '#d4edda';
        resultStatus.style.color = '#155724';
    } else {
        resultStatus.textContent = 'üìö You need more practice. Keep studying!';
        resultStatus.style.backgroundColor = '#f8d7da';
        resultStatus.style.color = '#721c24';
    }
    resultHeader.appendChild(resultStatus);
    quizAnalysisContainer.appendChild(resultHeader);
    
    // Create stats cards container
    const statsContainer = document.createElement('div');
    statsContainer.style.display = 'flex';
    statsContainer.style.justifyContent = 'space-between';
    statsContainer.style.flexWrap = 'wrap';
    statsContainer.style.gap = '10px';
    statsContainer.style.marginBottom = '25px';
    
    // Time taken card
    const timeCard = document.createElement('div');
    timeCard.className = 'stats-card';
    timeCard.style.flex = '1';
    timeCard.innerHTML = `
        <div class="stats-header">‚è±Ô∏è Time Taken</div>
        <div style="font-size: 1.5rem;">${timeElapsedFormatted}</div>
        <div style="color: #6c757d; font-size: 0.9rem;">out of ${Math.floor(examDuration/60)}:00 minutes</div>
    `;
    statsContainer.appendChild(timeCard);
    
    // Attempt rate card
    const attemptCard = document.createElement('div');
    attemptCard.className = 'stats-card';
    attemptCard.style.flex = '1';
    attemptCard.innerHTML = `
        <div class="stats-header">üìù Questions Attempted</div>
        <div style="font-size: 1.5rem;">${attemptedQuestions}/${data.total}</div>
        <div style="color: #6c757d; font-size: 0.9rem;">${attemptedPercent.toFixed(1)}% attempt rate</div>
    `;
    statsContainer.appendChild(attemptCard);
    
    // Accuracy card
    const accuracyCard = document.createElement('div');
    accuracyCard.className = 'stats-card';
    accuracyCard.style.flex = '1';
    
    const accuracy = attemptedQuestions > 0 ? (data.score / attemptedQuestions) * 100 : 0;
    accuracyCard.innerHTML = `
        <div class="stats-header">üéØ Accuracy</div>
        <div style="font-size: 1.5rem;">${accuracy.toFixed(1)}%</div>
        <div style="color: #6c757d; font-size: 0.9rem;">${data.score} correct out of ${attemptedQuestions} attempted</div>
    `;
    statsContainer.appendChild(accuracyCard);
    
    quizAnalysisContainer.appendChild(statsContainer);
    
    // Create performance visualization
    const performanceSection = document.createElement('div');
    performanceSection.style.marginBottom = '25px';
    performanceSection.innerHTML = `
        <h3 style="margin-bottom: 10px;">Performance Breakdown</h3>
        <div style="display: flex; align-items: center; margin-bottom: 5px;">
            <span style="width: 120px;">Correct:</span>
            <div style="flex-grow: 1; background-color: #e9ecef; border-radius: 5px; height: 10px;">
                <div class="progress-bar" style="background-color: #28a745; width: ${(data.score/data.total)*100}%;"></div>
            </div>
            <span style="margin-left: 10px;">${data.score}</span>
        </div>
        <div style="display: flex; align-items: center; margin-bottom: 5px;">
            <span style="width: 120px;">Incorrect:</span>
            <div style="flex-grow: 1; background-color: #e9ecef; border-radius: 5px; height: 10px;">
                <div class="progress-bar" style="background-color: #dc3545; width: ${((attemptedQuestions-data.score)/data.total)*100}%;"></div>
            </div>
            <span style="margin-left: 10px;">${attemptedQuestions-data.score}</span>
        </div>
        <div style="display: flex; align-items: center;">
            <span style="width: 120px;">Unattempted:</span>
            <div style="flex-grow: 1; background-color: #e9ecef; border-radius: 5px; height: 10px;">
                <div class="progress-bar" style="background-color: #6c757d; width: ${((data.total-attemptedQuestions)/data.total)*100}%;"></div>
            </div>
            <span style="margin-left: 10px;">${data.total-attemptedQuestions}</span>
        </div>
    `;
    quizAnalysisContainer.appendChild(performanceSection);
    
    // Show detailed answers if available
    if (data.answers && Object.keys(data.answers).length > 0) {
        const answersSection = document.createElement('div');
        answersSection.innerHTML = `<h3 style="margin-bottom: 15px;">Question Analysis</h3>`; 
        Object.keys(data.answers).forEach(questionId => {
            const answer = data.answers[questionId];
            const questionElement = document.createElement('div');
            questionElement.style.marginBottom = '20px';
            questionElement.style.padding = '15px';
            questionElement.style.backgroundColor = '#f8f9fa';
            questionElement.style.borderRadius = '8px';
            questionElement.style.border = '1px solid #dee2e6';
            
            const isCorrect = answer.correct;
            
            questionElement.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">Question ${questionId}: ${answer.question}</div>
                <div class="${isCorrect ? 'correct-answer' : 'incorrect-answer'}">
                    <div><strong>Your answer:</strong> ${answer.user_answer || 'Not answered'}</div>
                    ${!isCorrect ? `<div><strong>Correct answer:</strong> ${answer.correct_answer}</div>` : ''}
                    <div class="answer-feedback">${isCorrect ? '‚úÖ Correct' : '‚ùå Incorrect'}</div>
                </div>
            `;
            
            answersSection.appendChild(questionElement);
        });
        
        quizAnalysisContainer.appendChild(answersSection);
    }
    
    // Add print button
    const printButton = document.createElement('button');
    printButton.textContent = 'üñ®Ô∏è Print Results';
    printButton.style.padding = '10px 20px';
    printButton.style.backgroundColor = '#007bff';
    printButton.style.color = 'white';
    printButton.style.border = 'none';
    printButton.style.borderRadius = '5px';
    printButton.style.cursor = 'pointer';
    printButton.style.marginTop = '20px';
    printButton.onclick = () => window.print();
    quizAnalysisContainer.appendChild(printButton);
}const startExamBtn = document.getElementById('startExamBtn');
const examContent = document.getElementById('examContent');
const proctorOverlay = document.getElementById('proctorOverlay');
const quizQuestionsContainer = document.getElementById('quizQuestions');
const submitQuizBtn = document.getElementById('submitQuizBtn');
const quizResult = document.getElementById('quizResult');
const termsModal = document.getElementById('termsModal');
const acceptTermsBtn = document.getElementById('acceptTermsBtn');
const declineTermsBtn = document.getElementById('declineTermsBtn');
const examEndedModal = document.getElementById('examEndedModal');
const endTestBtn = document.getElementById('endTestBtn');

// Add timer elements
const examTimerContainer = document.createElement('div');
examTimerContainer.id = 'examTimerContainer';
examTimerContainer.style.backgroundColor = '#f8f9fa';
examTimerContainer.style.padding = '10px';
examTimerContainer.style.borderRadius = '5px';
examTimerContainer.style.marginBottom = '15px';
examTimerContainer.style.textAlign = 'center';
examTimerContainer.style.fontWeight = 'bold';
examTimerContainer.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
examTimerContainer.style.display = 'none'; // Hidden by default
examContent.insertBefore(examTimerContainer, examContent.firstChild);

const timerDisplay = document.createElement('div');
timerDisplay.id = 'timerDisplay';
timerDisplay.style.fontSize = '1.5rem';
timerDisplay.style.color = '#333';
examTimerContainer.appendChild(timerDisplay);

// Create result analysis div
const quizAnalysisContainer = document.createElement('div');
quizAnalysisContainer.id = 'quizAnalysisContainer';
quizAnalysisContainer.style.display = 'none';
quizAnalysisContainer.style.backgroundColor = '#fff';
quizAnalysisContainer.style.border = '1px solid #ddd';
quizAnalysisContainer.style.borderRadius = '8px';
quizAnalysisContainer.style.padding = '20px';
quizAnalysisContainer.style.marginTop = '20px';
quizAnalysisContainer.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
examContent.appendChild(quizAnalysisContainer);

// Timer variables
let examDuration = 30 * 60; // 30 minutes in seconds
let timerInterval;
let timeRemaining;
let examStartTimestamp;

// Violation tracking variables
let faceNotVisibleCount = 0;
let focusLostCount = 0;
let mobileDetectedCount = 0;
let totalViolations = 0;
const MAX_VIOLATIONS = 3;

// Store questions and answers
let quizQuestions = [];

// Functions
function showWarning(message) {
    // Create a warning element if it doesn't exist
    let warningElement = document.getElementById('violationWarning');
    if (!warningElement) {
        warningElement = document.createElement('div');
        warningElement.id = 'violationWarning';
        warningElement.style.backgroundColor = '#fff3cd';
        warningElement.style.color = '#856404';
        warningElement.style.border = '1px solid #ffeeba';
        warningElement.style.padding = '12px';
        warningElement.style.borderRadius = '8px';
        warningElement.style.margin = '10px 0';
        warningElement.style.textAlign = 'center';
        warningElement.style.fontWeight = 'bold';
        warningElement.style.animation = 'fadeIn 0.5s ease';
        
        // Add it to the top of the quiz area
        quizQuestionsContainer.parentNode.insertBefore(warningElement, quizQuestionsContainer);
    }
    
    // Set the warning message and make it visible
    warningElement.innerHTML = message;
    warningElement.style.display = 'block';
    
    // Make it flash to draw attention
    warningElement.style.animation = 'none';
    setTimeout(() => {
        warningElement.style.animation = 'fadeIn 0.5s ease';
    }, 10);
    
    // Auto hide after 5 seconds
    setTimeout(() => {
        warningElement.style.display = 'none';
    }, 5000);
}

function showTermsModal() {
    termsModal.style.display = "flex";
}

function hideTermsModal() {
    termsModal.style.display = "none";
}

function showExamEndedModal() {
    examEndedModal.style.display = "flex";
}

function hideExamEndedModal() {
    examEndedModal.style.display = "none";
}

function startExam() {
    examContent.style.display = "block";
    proctorOverlay.style.display = "block"; // Show proctoring overlay
    startExamBtn.style.display = "none";
    
    // Show and start timer
    examTimerContainer.style.display = "block";
    startTimer();

    loadQuizQuestions();  // Show quiz when exam starts

    // Call cheating detection every 3 seconds
    setInterval(() => {
        fetch('/detect')
            .then(response => response.json())
            .then(data => {
                const resultElement = document.getElementById("aiResult");
                if (data.cheating_detected) {
                    resultElement.textContent = data.reason;
                    resultElement.style.color = "red";
                    
                    // Check if violation is related to face not visible
                    if (data.reason.toLowerCase().includes("face") || 
                        data.reason.toLowerCase().includes("not visible")) {
                        faceNotVisibleCount++;
                        totalViolations = faceNotVisibleCount + focusLostCount + mobileDetectedCount;
                        
                        // Show warning with count
                        showWarning(`‚ö†Ô∏è Face not detected! Please stay visible during the exam. Violation ${totalViolations}/${MAX_VIOLATIONS}`);
                        
                        checkViolationsAndSubmit();
                    }
                } else {
                    resultElement.textContent = "‚úÖ No cheating detected";
                    resultElement.style.color = "green";
                }
            })
            .catch(err => {
                console.error("Detection failed", err);
            });
    }, 3000);
}

function startTimer() {
    timeRemaining = examDuration;
    examStartTimestamp = new Date();
    updateTimerDisplay();
    
    timerInterval = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();
        
        // Check if timer has run out
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            endExam("Time's up!");
        }
        
        // Change color when time is running low
        if (timeRemaining <= 300) { // 5 minutes remaining
            timerDisplay.style.color = '#dc3545'; // Red
            
            // Flash effect in the last minute
            if (timeRemaining <= 60) {
                timerDisplay.style.animation = 'timerFlash 1s infinite';
            }
        }
    }, 1000);
}

function updateTimerDisplay() {
    const minutes = Math.floor(timeRemaining / 60);
    const seconds = timeRemaining % 60;
    
    // Format time as MM:SS
    timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function endExam(reason) {
    clearInterval(timerInterval);
    
    // Calculate time taken
    const timeElapsed = examDuration - timeRemaining;
    
    // Log the event
    fetch('/log_cheating', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
            reason: reason || 'Exam ended',
            timeElapsed: timeElapsed,
            faceViolations: faceNotVisibleCount,
            tabViolations: focusLostCount,
            mobileViolations: mobileDetectedCount
        })
    });
    
    // Auto-submit the quiz
    submitQuiz();
    
    // Show exam ended modal
    const modalMessage = document.getElementById('examEndedMessage');
    if (modalMessage) {
        modalMessage.textContent = reason || 'Exam ended';
    }
    showExamEndedModal();
    
    // Hide exam content and proctor overlay to prevent further interaction
    examContent.style.display = "none";
    proctorOverlay.style.display = "none";
}

function loadQuizQuestions() {
    fetch('/quiz_questions')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch quiz questions');
            }
            return response.json();
        })
        .then(questions => {
            quizQuestions = questions;
            displayQuizQuestions(questions);
        })
        .catch(error => {
            console.error('Error loading questions:', error);
            quizQuestionsContainer.innerHTML = `
                <p style="color: red;">Failed to load quiz questions. Please try again.</p>
                <button onclick="loadQuizQuestions()">Retry</button>
            `;
        });
}

function displayQuizQuestions(questions) {
    quizQuestionsContainer.innerHTML = '';
    
    if (!questions || questions.length === 0) {
        quizQuestionsContainer.innerHTML = '<p>No questions available.</p>';
        return;
    }
    
    questions.forEach(question => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question';
        
        // Display the question text with HTML entities decoded
        const questionText = document.createElement('p');
        questionText.innerHTML = decodeHtmlEntities(question.question);
        questionDiv.appendChild(questionText);
        
        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'options';
        
        question.options.forEach(option => {
            const optionLabel = document.createElement('label');
            optionLabel.className = 'option';
            
            const optionInput = document.createElement('input');
            optionInput.type = 'radio';
            optionInput.name = `q${question.id}`;
            optionInput.value = option;
            
            const optionText = document.createElement('span');
            optionText.innerHTML = decodeHtmlEntities(option);
            
            optionLabel.appendChild(optionInput);
            optionLabel.appendChild(optionText);
            optionsDiv.appendChild(optionLabel);
        });
        
        questionDiv.appendChild(optionsDiv);
        quizQuestionsContainer.appendChild(questionDiv);
    });
    
    submitQuizBtn.style.display = "block";
}

function decodeHtmlEntities(text) {
    const textArea = document.createElement('textarea');
    textArea.innerHTML = text;
    return textArea.value;
}

function submitQuiz() {
    const answers = {};
    const radios = document.querySelectorAll('input[type="radio"]:checked');
    
    // Calculate time taken
    const timeElapsed = examDuration - timeRemaining;
    const timeElapsedMinutes = Math.floor(timeElapsed / 60);
    const timeElapsedSeconds = timeElapsed % 60;
    const timeElapsedFormatted = `${timeElapsedMinutes.toString().padStart(2, '0')}:${timeElapsedSeconds.toString().padStart(2, '0')}`;
    
    // Get the number of attempted questions
    const attemptedQuestions = radios.length;
    
    radios.forEach(radio => {
        const qid = radio.name.replace('q', '');
        answers[qid] = radio.value;
    });

    fetch('/submit_quiz', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
            answers: answers, 
            timeElapsed: timeElapsed,
            attempted: attemptedQuestions 
        })
    })
    .then(response => response.json())
    .then(data => {
        // Create detailed analysis
        displayQuizAnalysis(data, timeElapsedFormatted, attemptedQuestions);
        
        // Disable all radio buttons
        const radioInputs = document.querySelectorAll('input[type="radio"]');
        radioInputs.forEach(input => {
            input.disabled = true;
        });
        
        submitQuizBtn.style.display = "none";
    })
    .catch(error => {
        console.error('Error submitting quiz:', error);
        quizResult.textContent = "‚ö†Ô∏è Failed to submit quiz. Please try again.";
        quizResult.style.display = "block";
        quizResult.style.color = "red";
    });
}

function checkViolationsAndSubmit() {
    console.log("Checking violations: " + totalViolations + "/" + MAX_VIOLATIONS);
    if (totalViolations >= MAX_VIOLATIONS) {
        endExam('Auto-submitted after ' + MAX_VIOLATIONS + ' violations');
    }
}

function pollMobileDetection() {
    fetch('/mobile_detect')
        .then(response => response.json())
        .then(data => {
            const mobileWarning = document.getElementById('mobileWarning');
            if (data.mobile_detected) {
                mobileWarning.style.display = 'block';
                
                // Add mobile detection to violations count and show warning
                if (examContent.style.display === "block") {
                    // Only count as violation if exam has started
                    mobileDetectedCount++;
                    totalViolations = faceNotVisibleCount + focusLostCount + mobileDetectedCount;
                    
                    showWarning(`‚ö†Ô∏è Mobile phone detected! Please keep mobile devices away. Violation ${totalViolations}/${MAX_VIOLATIONS}`);
                    
                    // Log mobile detection as cheating
                    fetch('/log_cheating', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ reason: 'Mobile phone detected during exam' })
                    });
                    
                    // Check if max violations reached
                    checkViolationsAndSubmit();
                }
            } else {
                mobileWarning.style.display = 'none';
            }
        })
        .catch(err => {
            console.error('Mobile detection failed', err);
        });
}

// Add tab focus/blur detection for violation tracking
window.addEventListener('blur', function() {
    // Only count as violation if exam has started
    if (examContent.style.display === "block") {
        focusLostCount++;
        totalViolations = faceNotVisibleCount + focusLostCount + mobileDetectedCount;
        
        showWarning(`‚ö†Ô∏è Tab switching detected! Please stay on this tab. Violation ${totalViolations}/${MAX_VIOLATIONS}`);
        
        // Log tab switching as cheating
        fetch('/log_cheating', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ reason: 'Tab switching during exam' })
        });
        
        // Check if max violations reached
        checkViolationsAndSubmit();
    }
});

// Add CSS for timer flash animation
const styleSheet = document.createElement("style");
styleSheet.type = "text/css";
styleSheet.innerText = `
@keyframes timerFlash {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
.progress-bar {
    height: 10px;
    border-radius: 5px;
    margin-top: 5px;
    transition: width 0.3s ease;
}
.stats-card {
    margin: 10px 0;
    padding: 15px;
    border-radius: 8px;
    background-color: #f8f9fa;
}
.stats-header {
    font-size: 1.2rem;
    font-weight: bold;
    margin-bottom: 10px;
    color: #333;
}
.correct-answer {
    background-color: #d4edda;
    border-radius: 4px;
    padding: 8px;
    border-left: 4px solid #28a745;
}
.incorrect-answer {
    background-color: #f8d7da;
    border-radius: 4px;
    padding: 8px;
    border-left: 4px solid #dc3545;
}
.answer-feedback {
    margin-top: 5px;
    font-size: 0.9rem;
}
`;
document.head.appendChild(styleSheet);

// Event listeners
startExamBtn.addEventListener('click', function() {
    showTermsModal();
});

acceptTermsBtn.addEventListener('click', function() {
    hideTermsModal();
    startExam();
});

declineTermsBtn.addEventListener('click', function() {
    hideTermsModal();
    // Show warning message instead of alert
    showWarning("You must accept the terms and conditions to start the exam.");
});

submitQuizBtn.addEventListener('click', function() {
    clearInterval(timerInterval);
    submitQuiz();
});

// Add event listener for end test button
if (endTestBtn) {
    endTestBtn.addEventListener('click', function() {
        hideExamEndedModal();
        window.location.reload(); // Reload page to reset the exam
    });
}

// Timer configuration function
function setExamDuration(minutes) {
    examDuration = minutes * 60;
}

// Tab switching detection
document.addEventListener("visibilitychange", () => {
    if (document.hidden && examContent.style.display === "block") { // Only count if exam has started
        // User switched tab or minimized
        focusLostCount++;
        totalViolations = faceNotVisibleCount + focusLostCount + mobileDetectedCount;
        
        // Show warning instead of alert
        showWarning(`‚ö†Ô∏è Tab switching detected! Staying on this tab is required. Violation ${totalViolations}/${MAX_VIOLATIONS}`);

        // Notify backend about cheating
        fetch('/log_cheating', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ reason: 'Tab switched or window minimized' })
        });
        
        checkViolationsAndSubmit();
    }
});

endTestBtn.addEventListener('click', () => {
    // Redirect to homepage or logout page
    window.location.href = '/'; // Change this URL as needed
});

// Erica Chatbot Implementation
class EricaChatbot {
    constructor() {
      this.name = "Erica";
      this.greeting = "Hello! I'm Erica, your AI exam proctoring assistant. How can I help you today?";
      this.knowledgeBase = {
        examPrep: {
          systemRequirements: "To use our proctoring system, you'll need a computer with a webcam, microphone, and stable internet connection.",
          browserSupport: "Supported browsers: Chrome, Firefox, Edge, and Safari. Keep them updated.",
          preExamChecklist: "Checklist: 1) Webcam/mic working, 2) Apps closed, 3) Quiet space, 4) ID ready, 5) Stable internet."
        },
        authentication: {
          login: "Log in using your email and password. Forgot password? Use the recovery option.",
          accountIssues: "Account trouble? Check your email for verification or contact support@aiexamproctoring.com.",
          idVerification: "You'll need a government-issued photo ID for verification before the exam."
        },
        duringExam: {
          allowedItems: "Only permitted items (e.g., blank paper, calculator) allowed during exam.",
          behaviorRules: "Stay in camera view. Don't look away too long or use unauthorized items.",
          technicalIssues: "If there's a problem, use the 'Report Issue' button. Support will help quickly."
        },
        privacyAndSecurity: {
          dataProtection: "All recordings are encrypted and only used to maintain exam integrity.",
          recordingConsent: "You must give consent to be recorded for the duration of the exam."
        }
      };
    }

    greet() {
      return this.greeting;
    }

    processQuery(userInput) {
      const input = userInput.toLowerCase();
      if (this.containsAny(input, ["hi", "hello", "hey"])) return this.greet();
      if (this.containsAny(input, ["system", "requirements", "computer"])) return this.knowledgeBase.examPrep.systemRequirements;
      if (this.containsAny(input, ["browser", "chrome", "firefox"])) return this.knowledgeBase.examPrep.browserSupport;
      if (this.containsAny(input, ["prepare", "checklist", "ready"])) return this.knowledgeBase.examPrep.preExamChecklist;
      if (this.containsAny(input, ["login", "sign in", "password"])) return this.knowledgeBase.authentication.login;
      if (this.containsAny(input, ["id", "verify", "passport"])) return this.knowledgeBase.authentication.idVerification;
      if (this.containsAny(input, ["allowed", "bring", "items"])) return this.knowledgeBase.duringExam.allowedItems;
      if (this.containsAny(input, ["rules", "behavior", "cheating"])) return this.knowledgeBase.duringExam.behaviorRules;
      if (this.containsAny(input, ["technical", "crash", "problem"])) return this.knowledgeBase.duringExam.technicalIssues;
      if (this.containsAny(input, ["privacy", "recording", "security"])) return this.knowledgeBase.privacyAndSecurity.dataProtection;
      return "I'm not sure I understood that. Try asking about system requirements, login, rules, or privacy.";
    }

    containsAny(text, keywords) {
      return keywords.some(keyword => text.includes(keyword));
    }
}

const erica = new EricaChatbot();

function handleUserInput(message) {
    if (!message.trim()) return "Please type your question.";
    return erica.processQuery(message);
}

function initChatbot() {
    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');

    // Show Erica's welcome message
    addMessage('bot', erica.greet());

    sendButton.addEventListener('click', () => {
      const message = userInput.value;
      if (message.trim() !== '') {
        addMessage('user', message);
        const response = handleUserInput(message);
        addMessage('bot', response);
        userInput.value = '';
      }
    });

    // Allow pressing Enter to send
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendButton.click();
        }
    });

    function addMessage(sender, text) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      messageDiv.textContent = text;
      chatWindow.appendChild(messageDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }
}

// Initialize components
document.addEventListener('DOMContentLoaded', () => {
    initChatbot();
    pollMobileDetection(); // Initial mobile detection check
});

// Poll mobile detection every 3 seconds
setInterval(pollMobileDetection, 3000);


    </script>
</body>
</html>